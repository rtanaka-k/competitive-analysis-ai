# 競合分析AI v2.4 - システムプロンプト強化版

## 🔍 問題の原因

プロンプト（ユーザーメッセージ）だけでは不十分でした。
**システムプロンプト**が弱かったため、AIが指示を無視していました。

---

## ✅ v2.4の修正内容

### 1. システムプロンプトの大幅強化

**Before（v2.3）**:
```python
system="あなたはゲーム業界の競合分析専門家です。"
```

**After（v2.4）**:
```python
system="""あなたはゲーム業界の競合分析専門家です。

【絶対に守るべきルール】
1. すべての情報は必ずMarkdown表形式で出力すること
2. 表の形式: | 項目 | 値1 | 値2 | のように必ず縦棒(|)で区切ること
3. 箇条書き（-や•）は絶対に使用禁止
4. テキストのみの羅列は禁止
5. 自社タイトルのスコア・データも必ず記載すること（空欄禁止）
6. 新規タイトルの場合は「目標XX」「計画XX」という形で記載

【表形式の例】
```
| 項目 | FGO | モンスターストライク |
|------|-----|-------------------|
| 推定年間売上 | 950億円 | 800億円（目標） |
```

このような表形式を必ず使用してください。テキストのみの出力は不可です。"""
```

### 2. 全APIに適用

```
✅ Claude (Anthropic) - Prompt Caching使用時
✅ Claude (Anthropic) - キャッシュなし
✅ OpenAI - Assistants API (Vector Store使用時)
✅ OpenAI - Chat Completions API
```

### 3. 結果のバリデーション機能追加

```python
# 表形式が含まれているかチェック
table_count = result.count('|')
if table_count < 50:
    st.warning("⚠️ 表形式が少ない可能性があります。再実行を推奨します。")

# 自社タイトル名が含まれているかチェック
if our_product not in result:
    st.warning(f"⚠️ 自社タイトル「{our_product}」のデータが不足している可能性があります。")
```

---

## 🚀 デプロイ手順（重要）

### Step 1: ファイル名を確認

**重要**: Streamlit Cloudで実行しているファイル名を確認してください。

```
1. https://share.streamlit.io/ にアクセス
2. アプリを選択
3. Settings → General
4. Main file path を確認

例: competitive_analysis_fixed.py
```

### Step 2: 正しいファイルを更新

**パターンA**: Main file pathが`competitive_analysis_fixed.py`の場合

```bash
# ダウンロードしたファイルを competitive_analysis_fixed.py にリネーム
# または内容をコピー

git add competitive_analysis_fixed.py
git commit -m "v2.4: システムプロンプト強化"
git push
```

**パターンB**: Main file pathが別のファイル名の場合

```bash
# そのファイル名にリネームまたはコピー
git add [your_filename].py
git commit -m "v2.4: システムプロンプト強化"
git push
```

### Step 3: Streamlit Cloudで再起動

```
1. アプリを開く
2. 右上の「⋮」メニュー
3. 「Reboot app」
4. 1-2分待つ
```

### Step 4: ブラウザのキャッシュクリア（重要！）

```
# Chrome/Edge
Ctrl + Shift + Delete → キャッシュをクリア

# Mac
Cmd + Shift + Delete → キャッシュをクリア

または

# 強制リロード
Ctrl + F5 (Windows)
Cmd + Shift + R (Mac)
```

---

## 📋 動作確認チェックリスト

### ✅ 必ず確認すること

```
□ ファイルが正しく更新されている（GitHubで確認）
□ Streamlit Cloudが正しいファイルを実行している
□ ブラウザのキャッシュをクリアした
□ アプリを再起動した
□ 分析を実行した
```

### ✅ 期待される結果

```
□ 警告メッセージが表示されない
□ すべてのセクションが表形式
□ 自社スコアが記載されている
□ レーダーチャートが表示される
□ 詳細スコア比較に自社データがある
```

### ⚠️ 問題が続く場合

```
□ ログを確認（Manage app → Logs）
□ エラーメッセージを確認
□ どのファイルを読み込んでいるか確認
```

---

## 🔍 トラブルシューティング

### Q1: 依然として表形式にならない

**原因1**: ファイルが更新されていない

**確認**:
```bash
# GitHubでファイルの最終更新日時を確認
# 今日の日付になっているか？
```

**原因2**: 間違ったファイルを実行している

**確認**:
```
Streamlit Cloud → Settings → General → Main file path
このファイル名と、GitHubで更新したファイル名が一致しているか？
```

**原因3**: ブラウザキャッシュ

**解決**:
```
Ctrl + Shift + Delete でキャッシュクリア
または
シークレットモードで開く
```

---

### Q2: 自社スコアが依然として空欄

**原因**: 入力データ不足

**解決**:
```
分析実行時に以下を必ず入力：
✅ 自社タイトル情報（詳細に）
✅ 売上目標（具体的な数値）
✅ DAU/MAU目標（具体的な数値）
✅ 詳細情報（自社の強み・特徴）
```

**例**:
```
悪い例:
自社タイトル: Game X
売上目標: 未入力
DAU/MAU目標: 未入力

良い例:
自社タイトル: Game X
売上目標: 初年度50億円
DAU/MAU目標: 10万人/30万人
詳細情報: オリジナルIP、独自の協力プレイシステム、リアルタイムPvP機能
```

---

### Q3: 警告メッセージが出る

```
⚠️ 表形式が少ない可能性があります
→ 分析を再実行（AIの出力は確率的）

⚠️ 自社タイトルのデータが不足
→ 入力データをより詳細に記入
```

---

## 💡 さらなる改善（必要に応じて）

### A. Few-shot examples追加

プロンプトに実際の出力例を追加：

```python
prompt = f"""
【出力例】
## MARKET_ANALYSIS
### 市場規模とトレンド

| 項目 | FGO | モンスターストライク |
|------|-----|-------------------|
| 推定年間売上 | 950億円 | 800億円（目標） |
| 市場ランキング | TOP 3 | TOP 10（目標） |

このように必ず表形式で出力してください。

{original_prompt}
"""
```

### B. Temperature調整

より決定論的な出力にする：

```python
# Claude
message = client.messages.create(
    temperature=0.3,  # 0.7 → 0.3 に変更
    ...
)
```

---

## 📊 v2.3 vs v2.4 比較

### v2.3（前バージョン）

```
✅ プロンプトに表形式指示
❌ システムプロンプトが弱い
❌ バリデーション機能なし
結果: AIが指示を無視する可能性高
```

### v2.4（現在）

```
✅ プロンプトに表形式指示
✅ システムプロンプト強化（全API）
✅ バリデーション機能追加
✅ 具体的な例示
結果: AIが指示に従う可能性が大幅向上
```

---

## 🎯 まとめ

### 今回の修正の核心

```
問題: プロンプトだけでは不十分
解決: システムプロンプトを強化

プロンプト: ユーザーの質問（毎回変わる）
システムプロンプト: AIの振る舞い（固定）
→ システムプロンプトの方が強い影響力
```

### 必ずやること

```
1. ✅ 正しいファイル名で更新
2. ✅ GitHubにPush
3. ✅ Streamlit Cloud再起動
4. ✅ ブラウザキャッシュクリア
5. ✅ 分析を再実行
```

---

**作成日**: 2026年1月19日  
**バージョン**: v2.4 (システムプロンプト強化版)
**重要度**: 最高 - この修正で大幅改善が期待されます
